name: Domain Builder

on:
  repository_dispatch:
    types: [ domain-builder-wk ]
  workflow_dispatch:
    inputs:
      data:
        type: string
        description: 'Domain Builder data payload in JSON stringified format'
        required: true
      request_id:
        type: string
        description: 'Unique request identifier'
        required: true

jobs:
  domain-builder:
    name: Domain Builder Job
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        path: main-repo
    
    - name: Checkout ansible repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        repository: pagopa/payment-cloud-domain-builder
        ref: ${{ github.ref_name }}
        path: ansible
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.x'
    
    - name: Parse Payload and Generate Vars File
      env:
        CLIENT_PAYLOAD: ${{ github.event.inputs.data }}
        REQUEST_ID: ${{ github.event.inputs.request_id }}
      run: |
        echo "=== DEBUG: Full payload ==="
        echo "$CLIENT_PAYLOAD" | python3 -m json.tool
                
        python3 << 'EOF'
        import json, os, sys

        # Parse payload
        raw = os.environ.get('CLIENT_PAYLOAD', '{}')
        request_id = os.environ.get('REQUEST_ID', '{}')
        print(f"Raw payload length: {len(raw)}")
        
        try:
            payload = json.loads(raw)
            print(f"Parsed payload keys: {list(payload.keys())}")
        except json.JSONDecodeError as e:
            print(f"JSON decode error: {e}")
            sys.exit(1)

        extra_vars_str = json.dumps(payload)
        
        # Scrivi in un file invece che in GITHUB_ENV
        vars_file = 'ansible_extra_vars.txt'
        with open(vars_file, 'w') as f:
            f.write(extra_vars_str)
        
        print(f"Extra vars written to {vars_file}")
        
        # Scrivi solo le variabili piccole in GITHUB_ENV
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"DOMAIN_NAME={payload.get('domain_name','')}\n")
            f.write(f"PRODUCT_NAME={payload.get('product_name','')}\n")
            f.write(f"VARS_FILE={vars_file}\n")
            f.write(f"REQUEST_ID={request_id}\n")
        
        print("\n=== Environment variables written ===")
        EOF
    
    - name: Verify Variables File
      run: |
        echo "=== Verifying Variables File ==="
        echo "DOMAIN_NAME: ${DOMAIN_NAME}"
        echo "PRODUCT_NAME: ${PRODUCT_NAME}"
        echo "VARS_FILE: ${VARS_FILE}"
        echo ""
        echo "File size: $(wc -c < ${VARS_FILE}) bytes"
        echo "Variables count: $(wc -w < ${VARS_FILE}) words"
        echo ""
        echo "First 500 chars:"
        head -c 500 ${VARS_FILE}
        echo ""
        echo "..."
        echo ""
        echo "Last 500 chars:"
        tail -c 500 ${VARS_FILE}
    
    - name: Install Ansible
      run: |
        echo "Installing Ansible"
        python3 -m pip install ansible
    
    - name: Run Ansible Playbook
      id: ansible
      working-directory: ansible
      run: |
        echo "=== Ansible Execution Info ==="
        echo "Building domain: ${DOMAIN_NAME}"
        echo "Product: ${PRODUCT_NAME}"
        echo ""
        
        # Leggi le variabili dal file
        EXTRA_VARS=$(cat ../${VARS_FILE})
        
        if [ -z "${EXTRA_VARS}" ]; then
          echo "ERROR: EXTRA_VARS is empty!"
          exit 1
        fi
        
        echo "Extra vars loaded from file (length: ${#EXTRA_VARS})"
        echo "Running ansible-playbook..."
        
        ansible-playbook \
          -i src/inventory/hosts \
          src/domain-builder.yml \
          --extra-vars "${EXTRA_VARS}" \
          -vv

    - name: Show result
      if: always()
      run: |
        echo "=== Output Directory Structure ==="
        tree -R -a ansible/src/output || ls -laR ansible/src/output
    
    - name: Upload generated files
      if: steps.ansible.outcome == 'success'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: domain-${{ env.DOMAIN_NAME }}-output
        path: ansible/src/output/
        retention-days: 3

    - name: Save domain
      if: steps.ansible.outcome == 'success'
      run: |
        ### Copy artifacts
        mkdir -p /tmp/
        cp -r ansible/src/output/ /tmp/

    - name: Checkout pagopa-infra repository
      if: steps.ansible.outcome == 'success'
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        repository: pagopa/pagopa-infra
        token: ${{ secrets.PAT_GITHUB }}
        ref: main

    - name: Copy and commit artifacts
      if: steps.ansible.outcome == 'success'
      env:
        GH_TOKEN: ${{ secrets.PAT_GITHUB }}
      run: |
        # Create branch
        git checkout -b domain_builder/domain-${{ env.DOMAIN_NAME }}-${{ env.REQUEST_ID }}
        
        ### Copy artifacts
        cp -r /tmp/output/* src/domains/
        
        # Commit and push
        git config user.name "GitHub Action Bot"
        git config user.email "action@github.com"
        git add .
        git commit -m "Add domain artifacts for ${{ env.DOMAIN_NAME }} (Request ID: ${{ env.REQUEST_ID }})"
        git push origin domain_builder/domain-${{ env.DOMAIN_NAME }}-${{ env.REQUEST_ID }}
