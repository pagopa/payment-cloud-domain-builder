name: Domain Builder

on:
  repository_dispatch:
    types: [ domain-builder-wk ]

jobs:
  domain-builder:
    name: Domain Builder Job
    runs-on: ubuntu-latest
    outputs:
      domain_name: ${{ steps.set_var.outputs.DOMAIN_NAME }}
      product_name: ${{ steps.set_var.outputs.PRODUCT_NAME }}
      vars_file: ${{ steps.set_var.outputs.VARS_FILE }}
      request_id: ${{ steps.set_var.outputs.REQUEST_ID }}
      repo_name: ${{ steps.set_var.outputs.event.repository.name }}
      repo_owner: ${{ steps.set_var.outputs.event.repository.owner.login }}
      repo_url: ${{ steps.set_var.outputs.event.repository.html_url }}
      repo_ref: ${{ steps.set_var.outputs.ref }}
      repo_sha: ${{ steps.set_var.outputs.sha }}
      repo_actor: ${{ steps.set_var.outputs.actor }}
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        path: main-repo
    
    - name: Checkout ansible repository
      uses: actions/checkout@v4
      with:
        repository: pagopa/payment-cloud-domain-builder
        ref: main
        path: ansible
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Parse Payload and Generate Vars File
      env:
        CLIENT_PAYLOAD: ${{ toJson(github.event.client_payload) }}
      run: |
        echo "=== DEBUG: Full payload ==="
        echo "$CLIENT_PAYLOAD" | python3 -m json.tool
                
        python3 << 'EOF'
        import json, os, sys

        # Parse payload
        raw = os.environ.get('CLIENT_PAYLOAD', '{}')
        print(f"Raw payload length: {len(raw)}")
        
        try:
            payload = json.loads(raw)
            print(f"Parsed payload keys: {list(payload.keys())}")
        except json.JSONDecodeError as e:
            print(f"JSON decode error: {e}")
            sys.exit(1)

        # Extract data
        data = payload.get('data', {})
        metadata = payload.get('metadata', {})
        
        print(f"Data keys: {list(data.keys())}")
        print(f"Data content: {json.dumps(data, indent=2)}")
        print(f"Metadata: {json.dumps(metadata, indent=2)}")

        def q(val: str) -> str:
            """Quote and escape values for shell"""
            return "'" + str(val).replace("'", "'\"'\"'") + "'"

        extra_vars = []
        for key, value in data.items():
            if value is None:
                continue
            elif isinstance(value, bool):
                extra_vars.append(f"{key}={str(value).lower()}")
            elif isinstance(value, (int, float)):
                extra_vars.append(f"{key}={value}")
            elif isinstance(value, str):
                if value.strip():
                    extra_vars.append(f"{key}={q(value)}")
            elif isinstance(value, (dict, list)):
                extra_vars.append(f"{key}={q(json.dumps(value))}")

        extra_vars_str = " ".join(extra_vars)
        
        print(f"\n=== Generated extra vars ===")
        print(f"Count: {len(extra_vars)}")
        print(f"Length: {len(extra_vars_str)} characters")

        # Scrivi in un file invece che in GITHUB_ENV
        vars_file = 'ansible_extra_vars.txt'
        with open(vars_file, 'w') as f:
            f.write(extra_vars_str)
        
        print(f"Extra vars written to {vars_file}")
        
        # Scrivi solo le variabili piccole in GITHUB_ENV
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"DOMAIN_NAME={data.get('domain_name','')}\n")
            f.write(f"PRODUCT_NAME={data.get('product_name','')}\n")
            f.write(f"VARS_FILE={vars_file}\n")
            f.write(f"REQUEST_ID={metadata.get('requestId','')}\n")
        
        print("\n=== Environment variables written ===")
        EOF
    
    - name: Verify Variables File
      run: |
        echo "=== Verifying Variables File ==="
        echo "DOMAIN_NAME: ${DOMAIN_NAME}"
        echo "PRODUCT_NAME: ${PRODUCT_NAME}"
        echo "VARS_FILE: ${VARS_FILE}"
        echo ""
        echo "File size: $(wc -c < ${VARS_FILE}) bytes"
        echo "Variables count: $(wc -w < ${VARS_FILE}) words"
        echo ""
        echo "First 500 chars:"
        head -c 500 ${VARS_FILE}
        echo ""
        echo "..."
        echo ""
        echo "Last 500 chars:"
        tail -c 500 ${VARS_FILE}
    
    - name: Install Ansible
      run: |
        echo "Installing Ansible"
        python3 -m pip install ansible
    
    - name: Run Ansible Playbook
      working-directory: ansible
      run: |
        echo "=== Ansible Execution Info ==="
        echo "Building domain: ${DOMAIN_NAME}"
        echo "Product: ${PRODUCT_NAME}"
        echo ""
        
        # Leggi le variabili dal file
        EXTRA_VARS=$(cat ../${VARS_FILE})
        
        if [ -z "${EXTRA_VARS}" ]; then
          echo "ERROR: EXTRA_VARS is empty!"
          exit 1
        fi
        
        echo "Extra vars loaded from file (length: ${#EXTRA_VARS})"
        echo "Running ansible-playbook..."
        
        ansible-playbook \
          -i src/inventory/hosts \
          src/domain-builder.yml \
          --extra-vars "${EXTRA_VARS}" \
          -vv

    - name: Show result
      if: always()
      run: |
        echo "=== Output Directory Structure ==="
        tree -R -a ansible/src/output || ls -laR ansible/src/output
    
    - name: Upload generated files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: domain-${{ env.DOMAIN_NAME }}-output
        path: ansible/src/output/
        retention-days: 3

    - name: Set Vars
      id: set_vars
      run: |
        echo "DOMAIN_NAME=${{ env.DOMAIN_NAME }}" >> $GITHUB_OUTPUT
        echo "PRODUCT_NAME=${{ env.PRODUCT_NAME }}" >> $GITHUB_OUTPUT
        echo "VARS_FILE=${{ env.VARS_FILE }}" >> $GITHUB_OUTPUT
        echo "REQUEST_ID=${{ env.REQUEST_ID }}" >> $GITHUB_OUTPUT
        echo "REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
        echo "REPO_OWNER=${{ github.event.repository.owner.login }}" >> $GITHUB_OUTPUT
        echo "REPO_URL=${{ github.event.repository.html_url }}" >> $GITHUB_OUTPUT
        echo "REPO_REF=${{ github.ref }}" >> $GITHUB_OUTPUT
        echo "REPO_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "REPO_ACTOR=${{ github.actor }}" >> $GITHUB_OUTPUT

  push-artifacts:
    needs: domain-builder
    name: Push Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout pagopa-infra repository
        uses: actions/checkout@v4
        with:
          repository: pagopa/pagopa-infra
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: domain-${{ needs.domain-builder.outputs.domain_name }}-output
          path: downloaded-artifacts

      - name: Copy and commit artifacts
        run: |
          # Create branch
          git checkout -b feature/domain-${{ needs.domain-builder.outputs.domain_name }}-${{ needs.domain-builder.outputs.request_id }}
          
          ### Copy artifacts
          # Create domains directory if it doesn't exist
          mkdir -p src/domains/${{ needs.domain-builder.outputs.domain_name }}
          
          # Unzip and copy artifacts
          cd downloaded-artifacts && \
          find . -name "*.zip" -exec unzip {} -d ../src/domains/${{ needs.domain-builder.outputs.domain_name }} \; && \
          find . -type f ! -name "*.zip" -exec cp {} ../src/domains/${{ needs.domain-builder.outputs.domain_name }} \;
          
          # Commit and push
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"
          git add .
          git commit -m "Add domain artifacts for ${{ needs.domain-builder.outputs.domain_name }} (Request ID: ${{ needs.domain-builder.outputs.request_id }})"
          git push origin feature/domain-${{ needs.domain-builder.outputs.domain_name }}-${{ needs.domain-builder.outputs.request_id }}
