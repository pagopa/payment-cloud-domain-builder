name: Domain Builder

# Manual execution only
on:
  repository_dispatch:
    types: [ domain-builder-wk ]

jobs:
  domain-builder:
    name: Domain Builder Job
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        path: main-repo
    
    - name: Checkout ansible repository
      uses: actions/checkout@v4
      with:
        repository: pagopa/payment-cloud-domain-builder
        ref: main
        path: ansible
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Parse and Build Domain
      run: |
        echo "Installing Ansible"
        python3 -m pip install ansible

        python3 << 'EOF'
        import json, os

        payload = json.loads('''${{ toJson(github.event.client_payload) }}''') if '''${{ toJson(github.event.client_payload) }}''' else {}
        data = payload.get('data', payload)

        def q(val: str) -> str:
            # escape single quotes for Ansible extra-vars
            return "'" + str(val).replace("'", "'\"'\"'") + "'"

        extra_vars = []
        for key, value in data.items():
            if isinstance(value, bool):
                extra_vars.append(f"{key}={str(value).lower()}")
            elif value is None:
                continue
            elif isinstance(value, (int, float)):
                extra_vars.append(f"{key}={value}")
            else:
                extra_vars.append(f"{key}={q(value)}")

        extra_vars_str = " ".join(extra_vars)

        github_env = os.environ['GITHUB_ENV']
        with open(github_env, 'a') as f:
            f.write("EXTRA_VARS<<__EV__\n")
            f.write(extra_vars_str + "\n")
            f.write("__EV__\n")
            f.write(f"DOMAIN_NAME={data.get('domain_name','')}\n")
            f.write(f"PRODUCT_NAME={data.get('product_name','')}\n")
        EOF

        echo "Switching to ansible folder"
        cd ansible

        echo "Building domain: ${DOMAIN_NAME}"
        echo "Product: ${PRODUCT_NAME}"
        echo "Extra vars (length): $(printf "%s" "$EXTRA_VARS" | wc -c)"
        echo "Extra vars (preview): ${EXTRA_VARS:0:300}..."

        ansible-playbook -i src/inventory/hosts src/domain-builder.yml --extra-vars "$EXTRA_VARS"

    - name: Show result
      run: tree -R -a ansible/src/output
