name: Domain Builder

# Manual execution only
on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Configuration JSON'
        required: true
        type: string
        default: |
          {
            "domain_name": "",
            "product_name": "",
            "location": "westeurope",
            "vnet_name": "",
            "vnet_rg_name": "",
            "include_postgresql": false,
            "include_kubernetes": false,
            "tag_source": "module.tag_config.tags",
            "log_analytics_ws_name": "",
            "log_analytics_ws_rg_name": "",
            "include_tag_config_module": true,
            "monitor_rg_name": "",
            "monitor_action_group_slack_name": "",
            "monitor_action_group_email_name": "",
            "monitor_action_group_opsgenie_name": "",
            "is_dev_public": false,
            "aks_name": "",
            "aks_rg_name": ""
          }

jobs:
  domain-builder:
    name: Domain Builder Job
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        path: main-repo
    
    - name: Checkout ansible repository
      uses: actions/checkout@v4
      with:
        repository: pagopa/payment-cloud-domain-builder
        ref: main
        path: ansible
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Parse and Build Domain
      run: |
        echo "Installing Ansible"
        python3 -m pip install ansible
        
        echo "Parsing configuration"
        CONFIG='${{ inputs.config }}'
        
        # Parse JSON using Python
        python3 << 'EOF'
        
        import json
        import os
        
        config = json.loads('''${{ inputs.config }}''')
        # TODO When switched to repository_dispatch use: config = json.loads('''${{ github.event.client_payload.formData }}''')
        
        # Build extra vars string
        extra_vars = []
        for key, value in config.items():
            if isinstance(value, bool):
                extra_vars.append(f"{key}={str(value).lower()}")
            elif isinstance(value, str) and value != "":
                if key == "tag_source":
                    extra_vars.append(f"{key}='{value}'")
                else:
                    extra_vars.append(f"{key}={value}")
            elif not isinstance(value, str):
                extra_vars.append(f"{key}={value}")
        
        extra_vars_str = " ".join(extra_vars)
        
        # Write to environment file
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"EXTRA_VARS={extra_vars_str}\n")
            f.write(f"DOMAIN_NAME={config.get('domain_name', '')}\n")
            f.write(f"PRODUCT_NAME={config.get('product_name', '')}\n")
        EOF
        
        echo "Switching to ansible folder"
        cd ansible
        
        echo "Building domain $DOMAIN_NAME for product: $PRODUCT_NAME"
        echo "Extra vars: $EXTRA_VARS"
        
        # Execute Ansible with all variables
        ansible-playbook -i src/inventory/hosts src/domain-builder.yml \
          --extra-vars "$EXTRA_VARS"
        
        # Get output files from ansible
        cd ../main-repo
        
        # Configure git
        #git config user.name "github-actions[bot]"
        #git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create new branch
        #git checkout -b "domain-builder-$DOMAIN_NAME-${{ github.run_id }}"
        
        echo "Copying output files to the current repository"
        #cp -r ../ansible/output/* .
        
        # Add and commit changes
        #git add .
        #git commit -m "Domain $DOMAIN_NAME built for product: $PRODUCT_NAME"
        
        # Push the branch
        #git push --set-upstream origin "domain-builder-$DOMAIN_NAME-${{ github.run_id }}"
        
        echo "Domain $DOMAIN_NAME build completed and pushed to branch domain-builder-$DOMAIN_NAME-${{ github.run_id }}"

    - name: Show result
      run: tree -R -a ansible/src/output
