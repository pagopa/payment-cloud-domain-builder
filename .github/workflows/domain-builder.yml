name: Domain Builder

# Manual execution only
on:
  repository_dispatch:
    types: [ domain-builder-wk ]

jobs:
  domain-builder:
    name: Domain Builder Job
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        path: main-repo
    
    - name: Checkout ansible repository
      uses: actions/checkout@v4
      with:
        repository: pagopa/payment-cloud-domain-builder
        ref: main
        path: ansible
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Parse and Build Domain
      run: |
        echo "Installing Ansible"
        python3 -m pip install ansible
                
        # Parse JSON using Python
        python3 << 'EOF'
        
        import json
        import os

        config = json.loads('''${{ toJson(github.event.client_payload.data) }}''')
        # Build extra vars string
        extra_vars = []
        for key, value in config.items():
            if isinstance(value, bool):
                extra_vars.append(f"{key}={str(value).lower()}")
            elif isinstance(value, str) and value != "":
                if key == "tag_source":
                    extra_vars.append(f"{key}='{value}'")
                else:
                    extra_vars.append(f"{key}={value}")
            elif not isinstance(value, str):
                extra_vars.append(f"{key}={value}")

        extra_vars_str = " ".join(extra_vars)

        # Write to GITHUB_ENV using a heredoc to safely handle spaces/special chars
        github_env = os.environ['GITHUB_ENV']
        with open(github_env, 'a') as f:
            f.write("EXTRA_VARS<<__EV__\n")
            f.write(extra_vars_str + "\n")
            f.write("__EV__\n")
            f.write(f"DOMAIN_NAME={config.get('domain_name', '')}\n")
            f.write(f"PRODUCT_NAME={config.get('product_name', '')}\n")
        EOF

        echo "Switching to ansible folder"
        cd ansible

        # Debug: ensure environment variables are available and not truncated
        echo "Building domain: ${DOMAIN_NAME}"
        echo "Product: ${PRODUCT_NAME}"
        echo "Extra vars (length): $(printf "%s" "$EXTRA_VARS" | wc -c)"
        echo "Extra vars (preview): ${EXTRA_VARS:0:200}..."

        # Always quote EXTRA_VARS to preserve spacing
        ansible-playbook -i src/inventory/hosts src/domain-builder.yml \
          --extra-vars "$EXTRA_VARS"
        
        cd ../main-repo
        echo "Domain $DOMAIN_NAME build completed and pushed to branch domain-builder-$DOMAIN_NAME-${{ github.run_id }}"

    - name: Show result
      run: tree -R -a ansible/src/output
